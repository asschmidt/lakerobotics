/***********************************************************
 * Generated CAN Code File for Node
 ***********************************************************
 * Node: {{ nodeName }}
 * Network Version: {{ networkVersion }}
 *
 ***********************************************************
 * 
 **********************************************************/

#include <stdint.h>

#include <stm32f1xx_hal_can.h>

#include "{{nodeName}}_CAN_{{interfaceController}}.h"
 
 /*
  * Define functions for CAN Tx Message creation
  *
  */
{% for txMsg in txMessages %}
int8_t createMsg_{{txMsg.Message.ID}}(CAN_FRAME* pCANFrame, Msg_{{txMsg.Message.ID}}* pMsg)
{				
	{% set msgCANID = txMsg.Message.GeneratorData['CAN_ID'] | int %}
	{% if msgCANID <= 2047 %}
	pCANFrame->header.StdId = CAN_ID_{{txMsg.Message.ID}};
	pCANFrame->header.IDE   = CAN_ID_STD;
	{% else %}
	pCANFrame->header.ExtId = CAN_ID_{{txMsg.Message.ID}};
	pCANFrame->header.IDE   = CAN_ID_EXT;		
	{% endif %}
	
	pCANFrame->header.RTR = CAN_RTR_DATA;
	pCANFrame->header.DLC = {{txMsg.Message.GeneratorData["DLC"]}};
	{% set signalBits = namespace(bitCount = 0) %}		
	{%- for sig in txMsg.Message.Signals %}	
		{%- if sig.Signal.Size == 1 %}					
			{%- set signalSize = 8 %}
		{%- else %}				
			{%- set signalSize = sig.Signal.Size %}		
		{%- endif %}
		{%- set signalBits.bitCount = signalBits.bitCount + signalSize %}							
		{% if sig.Signal.Type == 2 %}
	// Signal	: {{sig.Signal.ID}}
	// Start-Bit: {{signalBits.bitCount - signalSize}} End-Bit: {{signalBits.bitCount - 1}}
			{%- set startByte = (signalBits.bitCount - signalSize) // 8 %}
			{% if sig.Signal.Size == 1 or sig.Signal.Size == 8 %}					
	pCANFrame->data[{{startByte}}] = (uint8_t)(pMsg->{{sig.Signal.ID}} & 0xFF);
			{% elif sig.Signal.Size == 16 %}					
	pCANFrame->data[{{startByte}}] = (uint8_t)((pMsg->{{sig.Signal.ID}} & 0xFF00) >> 8);
	pCANFrame->data[{{startByte + 1}}] = (uint8_t)(pMsg->{{sig.Signal.ID}} & 0x00FF);
			{% elif sig.Signal.Size == 32 %}					
	pCANFrame->data[{{startByte}}] = (uint8_t)((pMsg->{{sig.Signal.ID}} & 0xFF000000) >> 24);
	pCANFrame->data[{{startByte + 1}}] = (uint8_t)((pMsg->{{sig.Signal.ID}} & 0x00FF0000) >> 16);
	pCANFrame->data[{{startByte + 2}}] = (uint8_t)((pMsg->{{sig.Signal.ID}} & 0x0000FF00) >> 8);
	pCANFrame->data[{{startByte + 3}}] = (uint8_t)((pMsg->{{sig.Signal.ID}} & 0x000000FF));
			{%- endif %}
		{%- endif %}
	{%- endfor %}
			
	return 0;
}
	
{% endfor %}

 /*
  * Define functions for CAN Rx Message parsing
  *
  */
{% for rxMsg in rxMessages %}
int8_t parseMsg_{{rxMsg.Message.ID}}(CAN_FRAME* pCANFrame, Msg_{{rxMsg.Message.ID}}* pMsg)
{
	uint32_t canID = 0;
	
	{% set msgCANID = rxMsg.Message.GeneratorData['CAN_ID'] | int %}
	{%- if msgCANID > 2047 %}
	// Check the Extended ID 
	canID = pCANFrame->header.ExtID;
	{%- else %}
	// Check the Standard ID
	canID = pCANFrame->header.StdId;
	{%- endif %}		
	
	if (canID != CAN_ID_{{rxMsg.Message.ID}})
		return -1;

	// Check DLC
	if (pCANFrame->header.DLC != {{rxMsg.Message.GeneratorData["DLC"]}})
		return -1;
				
	// Extract the data from CAN-Frame
	{%- set signalBits = namespace(bitCount = 0) %}		
	{%- for sig in rxMsg.Message.Signals %}
		{%- if sig.Signal.Size == 1 %}					
			{%- set signalSize = 8 %}
		{%- else %}				
			{%- set signalSize = sig.Signal.Size %}		
		{%- endif %}
		{%- set signalBits.bitCount = signalBits.bitCount + signalSize %}			
		{% if sig.Signal.Type == 2 %}
	// Signal	: {{sig.Signal.ID}}
	// Start-Bit: {{signalBits.bitCount - signalSize}} End-Bit: {{signalBits.bitCount - 1}}
			{% set startByte = (signalBits.bitCount - signalSize) // 8 %}
			{% if sig.Signal.Size == 1 or sig.Signal.Size == 8 %}
	pMsg->{{sig.Signal.ID}} = pCANFrame->data[{{startByte}}]; 					
			{% elif sig.Signal.Size == 16 %}					
	pMsg->{{sig.Signal.ID}} = (pCANFrame->data[{{startByte}}] << 8) | 
							  (pCANFrame->data[{{startByte + 1}}]);										  				
			{% elif sig.Signal.Size == 32 %}					
	pMsg->{{sig.Signal.ID}} = (pCANFrame->data[{{startByte}}] << 24) | 
							  (pCANFrame->data[{{startByte + 1}}] << 16) |
							  (pCANFrame->data[{{startByte + 2}}] << 8) |
							  (pCANFrame->data[{{startByte + 3}}]);		
			{%- endif %}
		{%- endif %}
	{%- endfor %}
				
	return 0;
}
	
{%- endfor %}
 